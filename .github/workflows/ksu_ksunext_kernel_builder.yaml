name: Build Kernel with KernelSU + ksunext

on:
  workflow_dispatch:
    inputs:
      kernel_repo_url:
        description: 'URL to the kernel source repository'
        required: true
      boot_img_url:
        description: 'URL to stock boot or init_boot image'
        required: true
      defconfig:
        description: 'Base kernel defconfig (e.g., lahaina_qgki_defconfig)'
        default: 'vendor/lahaina-qgki_defconfig'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git make curl lz4 bc bison flex build-essential \
            libssl-dev libncurses5-dev python-is-python3 \
            gcc-aarch64-linux-gnu cpio unzip wget

      - name: Clone kernel source
        run: |
          git clone --depth=1 ${{ github.event.inputs.kernel_repo_url }} kernel

      - name: Clone KernelSU
        run: |
          git clone --depth=1 https://github.com/tiann/KernelSU kernel/kernelSU

      - name: Apply KernelSU config and ksunext patch
        run: |
          cd kernel
          cp arch/arm64/configs/${{ github.event.inputs.defconfig }} arch/arm64/configs/ksu_temp_defconfig
          echo 'CONFIG_KERNELSU=y' >> arch/arm64/configs/ksu_temp_defconfig
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -          

      - name: Download boot image
        run: |
          curl -L ${{ github.event.inputs.boot_img_url }} -o stock_boot.img

      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export KBUILD_BUILD_USER=github
          export KBUILD_BUILD_HOST=actions
          make O=out ksu_temp_defconfig
          make -j$(nproc) O=out

      - name: Debug kernel build output
        run: |
          ls -R kernel/out/arch/arm64/boot || echo "Kernel output folder empty!"

      - name: Repack boot image with new kernel
        run: |
          git clone https://github.com/topjohnwu/magiskboot.git
          cd magiskboot
          make
          cd ..
          ./magiskboot/magiskboot unpack stock_boot.img
          cp kernel/out/arch/arm64/boot/Image.gz-dtb ./kernel || cp kernel/out/arch/arm64/boot/Image.gz ./kernel
          ./magiskboot/magiskboot repack stock_boot.img
          ls -lh
          mv new-boot.img patched_boot.img || echo "Repack failed, no output image generated."

      - name: Show boot image details
        run: |
          file patched_boot.img || echo "No output image found! Something probably went wrong."

      - name: Upload patched boot image
        uses: actions/upload-artifact@v4.4.3
        with:
          name: patched-boot
          path: patched_boot.img
