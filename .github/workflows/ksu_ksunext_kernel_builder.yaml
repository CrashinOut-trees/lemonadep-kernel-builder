name: Build Kernel with KernelSU + ksunext

on:
  workflow_dispatch:
    inputs:
      boot_img_url:
        description: 'URL to stock boot or init_boot image'
        required: true
      defconfig:
        description: 'Base kernel defconfig (e.g., lahaina_qgki.defconfig)'
        default: 'lahaina_qgki.defconfig'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git make curl lz4 bc bison flex build-essential \
            libssl-dev libncurses5-dev python-is-python3 \
            gcc-aarch64-linux-gnu cpio unzip wget

      - name: Clone kernel source
        uses: actions/checkout@v3

      - name: Apply KernelSU
        run: |
          git submodule add https://github.com/KernelSU/KernelSU kernel/kernelSU || true
          cp arch/arm64/configs/${{ github.event.inputs.defconfig }} arch/arm64/configs/ksu_temp_defconfig
          echo 'CONFIG_KERNELSU=y' >> arch/arm64/configs/ksu_temp_defconfig

      - name: Apply ksunext patch
        run: |
          curl -L -o ksunext.patch https://your.patch.host/ksunext.patch
          git apply ksunext.patch

      - name: Download boot image
        run: |
          curl -L ${{ github.event.inputs.boot_img_url }} -o stock_boot.img

      - name: Set up environment
        run: |
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export KBUILD_BUILD_USER=github
          export KBUILD_BUILD_HOST=actions

      - name: Build Kernel
        run: |
          make O=out ksu_temp_defconfig
          make -j$(nproc) O=out

      - name: Repack boot image with new kernel
        run: |
          git clone https://github.com/topjohnwu/magiskboot.git
          cd magiskboot
          make
          cd ..
          ./magiskboot/magiskboot unpack stock_boot.img
          cp out/arch/arm64/boot/Image.gz-dtb ./kernel || cp out/arch/arm64/boot/Image.gz ./kernel
          ./magiskboot/magiskboot repack stock_boot.img
          ls -lh
          mv new-boot.img patched_boot.img || echo "Repack failed, no output image generated."

      - name: Show boot image details
        run: |
          file patched_boot.img || echo "No output image found! Something probably went wrong."

      - name: Upload patched boot image
        uses: actions/upload-artifact@v4
        with:
          name: patched-boot
          path: patched_boot.img
